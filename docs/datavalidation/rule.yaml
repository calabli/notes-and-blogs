## --- FATAL 级别：安全与权限（必须阻断，优先级最高） ---
#
#- id: "REMOTE_AUTH_CHECK"
#  level: "FATAL"
#  path: "$.metadata"
#  fetcher:
#    name: "genericHttpFetcher"
#    resultVar: "authInfo"
#    params:
#      method: "POST"
#      url: "http://api.internal.com/v1/auth-check"
#      headers: { "Content-Type": "application/json", "X-API-Key": "secret-123" }
#      bodyFields: ["name", "namespace"]
#  expression: "authInfo.code == 200 && authInfo.data.allowed == true"
#  message: "权限校验失败：当前操作者无权在指定命名空间部署"
#
#- id: "NAME_REQUIRED"
#  level: "FATAL"
#  path: "$.metadata"
#  expression: "utils:notEmpty(name)"
#  message: "致命错误：应用名称 (metadata.name) 不能为空"
#
## --- ERROR 级别：合规与配额（涉及资源申请，禁止部署） ---
#
#- id: "CPU_LIMIT"
#  level: "ERROR"
#  path: "$.spec.containers[*]"
#  forEach: true
#  expression: "cpu <= 8"
#  message: "合规错误：单容器 CPU 不能超过 8 核"
#
#- id: "CROSS_CHECK"
#  level: "ERROR"
#  path: "$.spec"
#  expression: "replicas * cpu_per_instance <= $.global_limit"
#  message: "配额错误：副本数 * 单实例核数 超出了全局配额限制"
#
#- id: "IMAGE_EXIST_CHECK"
#  level: "ERROR"
#  path: "$.spec.containers[*]"
#  forEach: true
#  fetcher:
#    name: "imageRepoFetcher"
#    resultVar: "repoStatus"
#    params: { "apiUrl": "https://api.harbor.com/v2/check" }
#  expression: "repoStatus.exists == true"
#  message: "部署错误：镜像在仓库中不存在或无权限访问"
#
#- id: "PORT_CONSISTENCY"
#  level: "ERROR"
#  path: "$.spec.network"
#  expression: "containerPort == servicePort"
#  message: "配置错误：容器端口与服务端口必须一致"
#
#- id: "DEPENDENCY_CHECK"
#  level: "ERROR"
#  path: "$.spec"
#  expression: "type == 'LoadBalancer' ? (protocol == 'TCP' || protocol == 'UDP') : true"
#  message: "依赖错误：当类型为 LoadBalancer 时，协议必须为 TCP 或 UDP"
#
#- id: "LOG_PATH_DEPENDENCY"
#  level: "ERROR"
#  path: "$.spec.sidecars[*]"
#  forEach: true
#  condition: "type == 'LogCollector'"
#  expression: "utils:notEmpty(logPath)"
#  message: "配置缺失：日志采集插件必须配置 logPath"
#
## --- WARN 级别：规范与优化（建议修改，不阻断部署） ---
#
#- id: "ENUM_CHECK"
#  level: "WARN"
#  path: "$.spec.region"
#  expression: "['cn-shanghai', 'cn-beijing'].contains(_this)"
#  message: "规范建议：当前地域非推荐地域，建议选择上海或北京"
#
#- id: "REPLICA_LIMIT"
#  level: "WARN"
#  path: "$.spec"
#  expression: "replicas >= 1 && replicas <= 10"
#  message: "优化建议：副本数建议保持在 1-10 之间以保证稳定性"
#
#- id: "CONTAINER_REQUIRED"
#  level: "WARN"
#  path: "$.spec"
#  expression: "utils:notEmpty(containers)"
#  message: "规范建议：部署配置中建议包含容器定义"
#
## 场景 A：全局扫描（从根节点开始递归）
#- id: "GLOBAL_CHAR_SECURITY"
#  level: "FATAL"
#  path: "$"
#  expression: "utils:isDeepSafe(_this, '@#$')"
#  message: "配置文档中包含非法敏感字符 (@, #, $)"
#
## 场景 B：局部扫描（只扫描 metadata 及其子节点）
#- id: "METADATA_CHAR_SECURITY"
#  level: "ERROR"
#  path: "$.metadata"
#  expression: "utils:isDeepSafe(_this, '%^&')"
#  message: "元数据区包含禁止使用的特殊符号"
#
#- id: "PROD_AUTH_CHECK"
#  level: "FATAL"
#  path: "$.metadata"
#  # 【关键点】前置条件：只有 namespace 匹配 'prod-*' 时才触发下面的 fetcher
#  condition: "namespace =~ 'prod-.*'"
#  fetcher:
#    name: "genericHttpFetcher"
#    resultVar: "authInfo"
#    params:
#      method: "POST"
#      url: "http://api.internal.com/v1/auth-check"
#      bodyFields: ["name", "namespace"]
#  expression: "authInfo.code == 200 && authInfo.data.allowed == true"
#  message: "生产环境权限校验失败：当前操作者无权操作 prod 命名空间"

- id: "PRIVATE_IMAGE_CHECK"
  level: "ERROR"
  path: "$.spec.containers[*]"
  forEach: true
  # 【条件】只有镜像名以 my-registry.com 开头时，才执行后面的逻辑
  condition: "image =~ 'my-registry.com/.*'"
  fetcher:
    name: "imageRepoFetcher"
    resultVar: "repoInfo"
    params:
      apiUrl: "https://api.my-registry.com/v2/check"
  # 【表达式】只有接口返回 exists 为 true 才算过
  expression: "repoInfo.exists == true"
  message: "私有镜像在仓库中不存在，请检查配置111"

#- id: "PRIVATE_IMAGE_CHECK2"
#  level: "INFO"
#  path: "$.spec.containers[*]"
#  forEach: true
#  fetcher:
#    name: "imageRepoFetcher"
#    resultVar: "repoInfo"
#    params:
#      apiUrl: "https://api.my-registry.com/v2/check"
#  # 【表达式】只有接口返回 exists 为 true 才算过
#  expression: "repoInfo.exists == true"
#  message: "私有镜像在仓库中不存在，请检查配置111"